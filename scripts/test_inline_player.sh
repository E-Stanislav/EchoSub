#!/bin/bash

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–∞ EchoSub
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–æ–∫–∞–¥—Ä–æ–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è

set -e

echo "üé¨ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–∞ EchoSub"
echo "================================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ FFmpeg
if ! command -v ffmpeg &> /dev/null; then
    echo "‚ùå FFmpeg –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ FFmpeg –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è."
    exit 1
fi

echo "‚úÖ FFmpeg –Ω–∞–π–¥–µ–Ω: $(ffmpeg -version | head -n1)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ
if [ ! -f "test_video.mp4" ]; then
    echo "üìπ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ..."
    
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ —Å –ø–æ–º–æ—â—å—é FFmpeg
    ffmpeg -f lavfi -i testsrc=duration=5:size=640x480:rate=10 \
           -f lavfi -i sine=frequency=440:duration=5 \
           -c:v libx264 -c:a aac \
           -shortest test_video.mp4 -y
    
    echo "‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ —Å–æ–∑–¥–∞–Ω–æ: test_video.mp4"
else
    echo "‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ –Ω–∞–π–¥–µ–Ω–æ: test_video.mp4"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏–¥–µ–æ
echo ""
echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ–æ:"
DURATION=$(ffprobe -v quiet -print_format json -show_format test_video.mp4 | jq -r '.format.duration')
VIDEO_INFO=$(ffprobe -v quiet -print_format json -show_streams test_video.mp4 | jq -r '.streams[] | select(.codec_type=="video") | (.width | tostring) + "x" + (.height | tostring)')
echo "   –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${DURATION} —Å–µ–∫"
echo "   –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${VIDEO_INFO} –ø–∏–∫—Å–µ–ª–µ–π"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤
echo ""
echo "üñºÔ∏è  –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤..."

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
TEMP_DIR=$(mktemp -d)
echo "üìÅ –í—Ä–µ–º–µ–Ω–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $TEMP_DIR"

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–¥—Ä—ã
echo "‚è≥ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤..."
ffmpeg -i test_video.mp4 -vf fps=10 -q:v 2 -y "$TEMP_DIR/frame_%04d.png" 2>/dev/null

# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤
FRAME_COUNT=$(ls "$TEMP_DIR"/frame_*.png | wc -l)
echo "‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–æ –∫–∞–¥—Ä–æ–≤: $FRAME_COUNT"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—á–µ—Å—Ç–≤–æ –∫–∞–¥—Ä–æ–≤
if [ $FRAME_COUNT -gt 0 ]; then
    FIRST_FRAME="$TEMP_DIR/frame_0001.png"
    if [ -f "$FIRST_FRAME" ]; then
        FRAME_SIZE=$(identify -format "%wx%h" "$FIRST_FRAME" 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        echo "üìê –†–∞–∑–º–µ—Ä –∫–∞–¥—Ä–∞: $FRAME_SIZE"
    fi
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤
echo ""
echo "‚ñ∂Ô∏è  –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤..."

# –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
if [ $FRAME_COUNT -gt 0 ]; then
    echo "‚è≥ –°–∏–º—É–ª—è—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è $FRAME_COUNT –∫–∞–¥—Ä–æ–≤..."
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–¥—Ä–æ–≤
    for i in {1..3}; do
        FRAME_FILE="$TEMP_DIR/frame_$(printf "%04d" $i).png"
        if [ -f "$FRAME_FILE" ]; then
            echo "   –ö–∞–¥—Ä $i: $(ls -lh "$FRAME_FILE" | awk '{print $5}')"
        fi
    done
    
    echo "‚úÖ –°–∏–º—É–ª—è—Ü–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
else
    echo "‚ùå –ù–µ—Ç –∫–∞–¥—Ä–æ–≤ –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è"
fi

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–æ—Ç–∫—É
echo ""
echo "‚è© –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–æ—Ç–∫–∏..."

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–º–æ—Ç–∫–∏
cat > "$TEMP_DIR/test_seek.sh" << 'EOF'
#!/bin/bash
# –¢–µ—Å—Ç –ø–µ—Ä–µ–º–æ—Ç–∫–∏ - –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–¥—Ä —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
VIDEO_FILE="$1"
SEEK_TIME="$2"
OUTPUT_FILE="$3"

ffmpeg -i "$VIDEO_FILE" -ss "$SEEK_TIME" -vframes 1 -q:v 2 -y "$OUTPUT_FILE" 2>/dev/null
EOF

chmod +x "$TEMP_DIR/test_seek.sh"

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–æ—Ç–∫—É –∫ —Ä–∞–∑–Ω—ã–º –ø–æ–∑–∏—Ü–∏—è–º
for seek_time in "1" "2.5" "4"; do
    output_file="$TEMP_DIR/seek_${seek_time}s.png"
    if "$TEMP_DIR/test_seek.sh" "test_video.mp4" "$seek_time" "$output_file"; then
        echo "‚úÖ –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –∫ ${seek_time}—Å: $(ls -lh "$output_file" | awk '{print $5}')"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–æ—Ç–∫–∏ –∫ ${seek_time}—Å"
    fi
done

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
echo ""
echo "‚ö° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏..."

# –ò–∑–º–µ—Ä—è–µ–º –≤—Ä–µ–º—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤
echo "‚è±Ô∏è  –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤..."
START_TIME=$(date +%s.%N)
ffmpeg -i test_video.mp4 -vf fps=10 -q:v 2 -y "$TEMP_DIR/benchmark_%04d.png" 2>/dev/null
END_TIME=$(date +%s.%N)

EXTRACTION_TIME=$(echo "$END_TIME - $START_TIME" | bc -l)
BENCHMARK_COUNT=$(ls "$TEMP_DIR"/benchmark_*.png | wc -l)
FPS=$(echo "scale=2; $BENCHMARK_COUNT / $EXTRACTION_TIME" | bc -l)

echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:"
echo "   –í—Ä–µ–º—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è: ${EXTRACTION_TIME}—Å"
echo "   –ö–∞–¥—Ä–æ–≤ –∏–∑–≤–ª–µ—á–µ–Ω–æ: $BENCHMARK_COUNT"
echo "   –°–∫–æ—Ä–æ—Å—Ç—å: ${FPS} –∫–∞–¥—Ä–æ–≤/—Å–µ–∫"

# –û—á–∏—Å—Ç–∫–∞
echo ""
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
rm -rf "$TEMP_DIR"

echo ""
echo "üéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ–ø–ª–µ–µ—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –†–µ–∑—é–º–µ:"
echo "   ‚úÖ FFmpeg —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
echo "   ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç"
echo "   ‚úÖ –ü–µ—Ä–µ–º–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç"
echo "   ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑–º–µ—Ä–µ–Ω–∞"
echo ""
echo "üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ EchoSub!" 