#!/bin/bash

echo "=== Тестирование Медиаплеера EchoSub ==="

# Проверяем наличие тестовых файлов
echo "1. Проверка тестовых файлов..."

if [ ! -f "test_audio.mp3" ]; then
    echo "❌ test_audio.mp3 не найден. Запустите test_ffmpeg.sh сначала."
    exit 1
fi

if [ ! -f "test_video.mp4" ]; then
    echo "❌ test_video.mp4 не найден. Запустите test_ffmpeg.sh сначала."
    exit 1
fi

echo "✓ Тестовые файлы найдены"

# Проверяем наличие ffplay
echo "2. Проверка ffplay..."

if ! command -v ffplay &> /dev/null; then
    echo "❌ ffplay не найден. Установите FFmpeg с поддержкой ffplay."
    exit 1
fi

echo "✓ ffplay найден: $(which ffplay)"

# Проверяем наличие скомпилированного приложения
echo "3. Проверка скомпилированного приложения..."

if [ ! -f "echosub" ]; then
    echo "❌ echosub не найден. Скомпилируйте приложение: go build -o echosub ./cmd/echosub"
    exit 1
fi

echo "✓ Приложение найдено"

# Тестируем ffplay напрямую
echo "4. Тестирование ffplay..."

echo "Тестирование аудио файла..."
timeout 3s ffplay -nodisp -autoexit test_audio.mp3 > /dev/null 2>&1
if [ $? -eq 0 ] || [ $? -eq 124 ]; then
    echo "✓ Аудио воспроизведение работает"
else
    echo "⚠️ Аудио воспроизведение может не работать"
fi

echo "Тестирование видео файла..."
timeout 3s ffplay -autoexit test_video.mp4 > /dev/null 2>&1
if [ $? -eq 0 ] || [ $? -eq 124 ]; then
    echo "✓ Видео воспроизведение работает"
else
    echo "⚠️ Видео воспроизведение может не работать"
fi

# Инструкции для тестирования
echo ""
echo "=== Инструкции для тестирования Медиаплеера ==="
echo ""
echo "1. Запустите приложение:"
echo "   ./echosub"
echo ""
echo "2. Загрузите медиа-файл:"
echo "   - Перетащите test_audio.mp3 или test_video.mp4 в окно"
echo "   - Или нажмите 'Открыть файл' и выберите файл"
echo ""
echo "3. Проверьте контролы плеера:"
echo "   - Должны появиться кнопки '▶ Воспроизвести' и '⏹ Стоп'"
echo "   - Должен появиться прогресс-бар"
echo "   - Должно отображаться время (00:00 / 00:05)"
echo ""
echo "4. Тестируйте воспроизведение:"
echo "   - Нажмите '▶ Воспроизвести' - должно открыться окно ffplay"
echo "   - Для аудио: должно воспроизводиться звук"
echo "   - Для видео: должно открыться окно с видео"
echo "   - Нажмите '⏹ Стоп' - должно остановиться"
echo ""
echo "5. Тестируйте перемотку:"
echo "   - Перетащите ползунок прогресс-бара"
echo "   - Время должно обновляться"
echo ""
echo "=== Готово к тестированию! ===" 